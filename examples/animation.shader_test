[require]
depthstencil X8_D24_UNORM_PACK32

[vertex shader]

#version 420 core

/* This is the vector [-1, 2, -3] rotated by -30Â° along the x axis and
 * then normalised. This was calculated with this snippet of python:
 * import numpy
 * import math
 * angle = -30.0 * math.pi / 180.0
 * rotation = [[1.0, 0.0, 0.0],
 *             [0.0, math.cos(angle), -math.sin(angle)],
 *             [0.0, math.sin(angle), math.cos(angle)]]
 * norm = [-1, 2, -3]
 * trans_norm = numpy.dot(rotation, norm)
 * norm_norm = numpy.divide(trans_norm,
 *                          numpy.sqrt(numpy.dot(trans_norm, trans_norm)))
 * print norm_norm
 */
const vec3 light_direction = vec3(-0.26726124, 0.06201819, -0.96162632);

const float ambient_light = 0.5;
const float diffuse = 1.0 - ambient_light;

float
get_lighting_tint(mat3 normal_transform,
                  vec3 normal)
{
        /* Transform the normal */
        normal = normal_transform * normal;
        /* Start with the ambient light */
        float light_factor = ambient_light;
        /* Calculate the diffuse factor based on the angle between the
           vertex normal and light direction */
        float diffuse_factor = max(0.0, dot(-light_direction, normal));
        /* Skip the diffuse term if the vertex is not facing
           the light */
        if (diffuse_factor > 0.0) {
                /* Add the diffuse term */
                light_factor += diffuse_factor * diffuse;
        }

        return light_factor;
}

layout(location = 0) in vec3 position;
layout(location = 2) in vec3 normal_attrib;
layout(location = 3) in vec3 color_attrib;

layout(std140, binding = 0) uniform block {
        mat4 transform;
        mat3 normal_transform;
};

layout(std140, push_constant) uniform push_block {
        uint frame_num;
};

layout(location = 0) out vec4 color;

void
main()
{
        float rotation = ((frame_num + gl_InstanceIndex * 10) *
                          3.141295654 * 2.0 / 60.0);
        float srot = sin(rotation);
        float crot = cos(rotation);
        vec3 pos = vec3(mat2(crot, -srot, srot, crot) * position.xy,
                        position.z);
        pos.x += (gl_InstanceIndex % 5) * 1.8;
        pos.y += (3.0 - (gl_InstanceIndex / 5)) * 2.0;
        gl_Position = transform * vec4(pos, 1.0);
        color.rgb = color_attrib * get_lighting_tint(normal_transform,
                                                     normal_attrib);
        color.a = 1.0;
}

[fragment shader]

#version 430 core

layout(location = 0) in vec4 color;
layout(location = 0) out vec4 frag_color;

void
main()
{
        frag_color = color;
}

[vertex data]
0/R32G32B32_SFLOAT         2/R32G32B32_SFLOAT          3/R8G8B8_UNORM
0.487105 0.322536 0.683244 0.369610 0.929014 -0.016205 255 255 255
0.487477 0.322536 0.587578 0.358806 0.874783 -0.325510 255 255 255
0.165357 0.363154 0.633389 -0.209479 0.924558 -0.318247 255 255 255
0.654134 0.203198 0.683244 0.811304 0.578875 -0.081637 255 255 255
0.645798 0.203199 0.587578 0.757378 0.527635 -0.384655 255 255 255
0.541383 0.196092 0.494621 0.531449 0.445631 -0.720359 255 255 255
-0.020076 0.191545 0.384504 0.003235 0.983917 -0.178472 255 255 255
0.359179 0.284514 0.494621 0.095157 0.814966 -0.571581 255 255 255
0.401905 0.196108 0.384504 0.377911 0.535173 -0.755455 255 255 255
0.238686 0.341285 0.580122 -0.072939 0.843898 -0.531480 255 255 255
-0.010122 0.221991 0.545612 -0.139866 0.952666 -0.269875 255 255 255
-0.590059 0.343555 1.314751 -0.989776 0.000092 0.142491 255 255 255
-0.606310 0.381184 1.201853 -0.989776 0.000092 0.142491 255 255 255
-0.606355 0.000063 1.201853 -0.989776 0.000092 0.142491 255 255 255
-0.590100 0.000061 1.314751 -0.989776 0.000092 0.142491 255 255 255
-0.292220 0.000026 1.282240 0.108493 0.000000 0.994079 255 255 255
-0.292179 0.343520 1.282240 0.108493 0.000000 0.994079 255 255 255
-0.590059 0.343555 1.314751 0.108493 0.000000 0.994079 255 255 255
-0.590100 0.000061 1.314751 0.108493 0.000000 0.994079 255 255 255
0.311885 -0.000045 0.318539 0.911588 -0.000092 -0.411023 255 255 255
0.370875 -0.000052 -0.003881 0.983642 -0.000092 0.179968 255 255 255
0.311895 0.083745 0.318539 0.915983 0.023225 -0.400464 255 255 255
-0.293826 0.200582 0.346404 -0.703207 0.695303 -0.148320 255 255 255
-0.301615 0.222062 0.442798 -0.493973 0.742912 -0.451643 255 255 255
0.311904 0.162748 0.318539 0.528947 0.750206 -0.396649 255 255 255
-0.318466 0.246527 -0.003881 -0.650655 0.739738 0.171453 255 255 255
-0.284764 0.195169 0.234268 -0.684347 0.727714 0.045137 255 255 255
0.370894 0.162741 -0.003881 0.755455 0.627491 0.188421 255 255 255
-0.263277 0.255016 0.602567 0.264290 0.919279 -0.291604 255 255 255
-0.225068 0.275739 0.686252 0.182958 0.943754 0.275369 255 255 255
-0.013154 0.240357 0.617998 -0.237465 0.908689 -0.343303 255 255 255
-0.308411 0.381148 0.687254 0.345561 0.927122 -0.144810 255 255 255
-0.308455 0.000028 0.687254 0.012024 0.000000 0.999908 255 255 255
-0.275919 0.381144 1.201853 0.980132 -0.000092 0.198187 255 255 255
-0.292179 0.343520 1.282240 0.980132 -0.000092 0.198187 255 255 255
-0.292220 0.000026 1.282240 0.980132 -0.000092 0.198187 255 255 255
-0.275964 0.000024 1.201853 0.980132 -0.000092 0.198187 255 255 255
-0.606355 0.000063 1.201853 -0.999969 0.000092 -0.006714 255 255 255
-0.606310 0.381184 1.201853 -0.999969 0.000092 -0.006714 255 255 255
-0.602838 0.381183 0.686441 -0.999969 0.000092 -0.006714 255 255 255
-0.602883 0.000063 0.686441 -0.999969 0.000092 -0.006714 255 255 255
0.726029 -0.000093 0.683244 0.990936 -0.000092 -0.134159 255 255 255
0.708459 -0.000091 0.587578 0.899869 -0.000092 -0.436110 255 255 255
-0.602838 0.381183 0.686441 0.000092 1.000000 0.000000 255 255 255
-0.606310 0.381184 1.201853 0.000092 1.000000 0.000000 255 255 255
-0.275919 0.381144 1.201853 0.000092 1.000000 0.000000 255 255 255
-0.308411 0.381148 0.687254 0.000092 1.000000 0.000000 255 255 255
0.615091 -0.000080 0.494621 0.633015 -0.000061 -0.774132 255 255 255
0.429891 -0.000059 0.384504 0.540330 -0.000061 -0.841426 255 255 255
-0.513387 0.381173 0.575675 -0.183172 0.553240 -0.812586 255 255 255
-0.513432 0.000052 0.575675 -0.540544 0.000061 -0.841304 255 255 255
-0.602883 0.000063 0.686441 -0.777978 0.000061 -0.628254 255 255 255
-0.602838 0.381183 0.686441 -0.515549 0.413984 -0.750206 255 255 255
-0.385190 0.273801 0.542839 -0.114475 0.379498 -0.918058 255 255 255
-0.385223 0.000037 0.542839 -0.533494 0.000061 -0.845759 255 255 255
-0.301641 0.000027 0.442798 -0.925535 0.000092 -0.378613 255 255 255
-0.293850 0.000027 0.346404 -0.996734 0.000092 -0.080538 255 255 255
-0.284787 0.000025 0.234268 -0.999542 0.000092 0.029969 255 255 255
0.155364 0.368338 0.685249 -0.241707 0.952086 -0.187323 255 255 255
-0.030732 0.276653 0.685750 -0.184240 0.845668 -0.500839 255 255 255
-0.038817 0.205947 0.468709 -0.027314 0.981689 -0.188360 255 255 255
-0.252301 0.241526 0.557752 0.180334 0.950468 -0.253090 255 255 255
-0.318495 0.000029 -0.003881 -0.990112 0.000092 0.140141 255 255 255
-0.275919 0.381144 1.201853 0.018860 0.931669 0.362743 255 255 255
-0.606310 0.381184 1.201853 0.018860 0.931669 0.362743 255 255 255
-0.590059 0.343555 1.314751 0.018860 0.931669 0.362743 255 255 255
-0.292179 0.343520 1.282240 0.018860 0.931669 0.362743 255 255 255
-0.275964 0.000024 1.201853 0.997986 -0.000092 -0.062990 255 255 255
-0.308455 0.000028 0.687254 0.997986 -0.000092 -0.062990 255 255 255
-0.308411 0.381148 0.687254 0.997986 -0.000092 -0.062990 255 255 255
-0.275919 0.381144 1.201853 0.997986 -0.000092 -0.062990 255 255 255
0.088174 0.084123 0.345634 0.008637 -0.006317 0.999939 65 69 189
0.061718 -0.000015 0.345132 0.007843 0.000000 0.999939 65 69 189
0.316696 -0.000045 0.343127 0.010559 0.000000 0.999939 65 69 189
0.144370 0.111809 0.345132 0.012177 0.000855 0.999908 65 69 189
0.244547 0.097978 0.343127 0.019623 0.014435 0.999695 65 69 189
0.294986 0.061941 0.343127 0.000000 0.000000 1.000000 65 69 189
0.448690 0.256977 0.614352 -0.313364 -0.696829 0.645100 255 255 255
0.183709 0.293562 0.616357 0.110996 -0.833369 0.541429 255 255 255
0.144370 0.111809 0.345132 0.175024 -0.829737 0.529984 255 255 255
0.244547 0.097978 0.343127 -0.240669 -0.746727 0.620045 255 255 255
0.582106 0.161655 0.614352 -0.557665 -0.388531 0.733482 255 255 255
0.294986 0.061941 0.343127 -0.528153 -0.445204 0.723045 255 255 255
0.639534 -0.000083 0.614352 -0.643483 0.000061 0.765435 255 255 255
0.316696 -0.000045 0.343127 -0.643483 0.000061 0.765435 255 255 255
0.035063 0.220327 0.616859 0.653066 -0.617725 0.438032 255 255 255
-0.034916 -0.000004 0.616357 0.942106 -0.000092 0.335246 255 255 255
0.061718 -0.000015 0.345132 0.942106 -0.000092 0.335246 255 255 255
0.088174 0.084123 0.345634 0.727317 -0.545488 0.416395 255 255 255
0.448690 0.256977 0.683244 -0.369243 -0.929319 0.000000 255 255 255
0.183709 0.293562 0.685249 0.160588 -0.986999 0.000000 255 255 255
0.183709 0.293562 0.616357 0.158574 -0.987335 0.000000 255 255 255
0.448690 0.256977 0.614352 -0.370312 -0.928892 0.000000 255 255 255
0.582106 0.161655 0.683244 -0.798608 -0.601825 0.000000 255 255 255
0.582106 0.161655 0.614352 -0.798608 -0.601825 0.000000 255 255 255
0.639534 -0.000083 0.683244 -1.000000 0.000092 0.000000 255 255 255
0.639534 -0.000083 0.614352 -1.000000 0.000092 0.000000 255 255 255
0.035063 0.220327 0.685750 0.758232 -0.651936 0.000000 255 255 255
-0.034916 -0.000004 0.685249 1.000000 -0.000092 0.000000 255 255 255
-0.034916 -0.000004 0.616357 0.999969 -0.000092 0.000000 255 255 255
0.035063 0.220327 0.616859 0.758080 -0.652120 0.000000 255 255 255
-0.030732 0.276653 0.685750 0.002441 -0.000122 0.999969 255 255 255
-0.225068 0.275739 0.686252 0.002564 0.002838 0.999969 255 255 255
-0.308455 0.000028 0.687254 0.007447 0.000000 0.999969 255 255 255
-0.118342 0.000006 0.685249 0.006012 0.000000 0.999969 255 255 255
0.487105 0.322536 0.683244 0.002930 -0.000183 0.999969 255 255 255
0.155364 0.368338 0.685249 0.004059 0.000702 0.999969 255 255 255
0.183709 0.293562 0.685249 0.004669 0.000427 0.999969 255 255 255
0.448690 0.256977 0.683244 0.003601 -0.000244 0.999969 255 255 255
0.654134 0.203198 0.683244 0.000000 0.000000 1.000000 255 255 255
0.582106 0.161655 0.683244 0.000000 0.000000 1.000000 255 255 255
0.726029 -0.000093 0.683244 0.000000 0.000000 1.000000 255 255 255
0.639534 -0.000083 0.683244 0.000000 0.000000 1.000000 255 255 255
-0.034916 -0.000004 0.685249 -0.000671 0.000000 0.999969 255 255 255
0.035063 0.220327 0.685750 0.000763 -0.000092 0.999969 255 255 255
0.487029 -0.322667 0.683244 0.369396 -0.929106 -0.016205 255 255 255
0.165272 -0.363209 0.633389 -0.209693 -0.924497 -0.318247 255 255 255
0.487401 -0.322667 0.587578 0.358592 -0.874874 -0.325510 255 255 255
0.654086 -0.203368 0.683244 0.811151 -0.579058 -0.081637 255 255 255
0.645751 -0.203367 0.587578 0.757225 -0.527818 -0.384655 255 255 255
0.541337 -0.196235 0.494621 0.531358 -0.445753 -0.720359 255 255 255
-0.020121 -0.191556 0.384504 0.002991 -0.983917 -0.178472 255 255 255
0.401859 -0.196219 0.384504 0.377789 -0.535264 -0.755455 255 255 255
0.359112 -0.284614 0.494621 0.094943 -0.814997 -0.571581 255 255 255
0.238605 -0.341357 0.580122 -0.073122 -0.843867 -0.531480 255 255 255
-0.010174 -0.222005 0.545612 -0.140080 -0.952635 -0.269875 255 255 255
-0.590140 -0.343432 1.314751 -0.989776 0.000092 0.142491 255 255 255
-0.606400 -0.381057 1.201853 -0.989776 0.000092 0.142491 255 255 255
-0.590140 -0.343432 1.314751 0.108493 0.000000 0.994079 255 255 255
-0.292260 -0.343467 1.282240 0.108493 0.000000 0.994079 255 255 255
0.311875 -0.083834 0.318539 0.915983 -0.023438 -0.400464 255 255 255
-0.301667 -0.222007 0.442798 -0.494156 -0.742821 -0.451643 255 255 255
-0.293874 -0.200529 0.346404 -0.703360 -0.695151 -0.148320 255 255 255
0.311866 -0.162838 0.318539 0.528764 -0.750328 -0.396649 255 255 255
-0.318524 -0.246468 -0.003881 -0.650838 -0.739586 0.171453 255 255 255
0.370856 -0.162844 -0.003881 0.755303 -0.627674 0.188421 255 255 255
-0.284810 -0.195118 0.234268 -0.684530 -0.727561 0.045137 255 255 255
-0.263337 -0.254970 0.602567 0.264077 -0.919340 -0.291604 255 255 255
-0.013211 -0.240370 0.617998 -0.237678 -0.908628 -0.343303 255 255 255
-0.225133 -0.275702 0.686252 0.182714 -0.943785 0.275369 255 255 255
-0.308500 -0.381092 0.687254 0.345347 -0.927213 -0.144810 255 255 255
-0.606355 0.000063 1.201853 0.000092 1.000000 0.000000 255 255 255
-0.590100 0.000061 1.314751 0.000092 0.999969 0.000000 255 255 255
-0.292220 0.000026 1.282240 0.000092 1.000000 0.000000 255 255 255
-0.275964 0.000024 1.201853 0.000092 1.000000 0.000000 255 255 255
-0.276009 -0.381096 1.201853 0.980132 -0.000092 0.198187 255 255 255
-0.292260 -0.343467 1.282240 0.980132 -0.000092 0.198187 255 255 255
-0.602927 -0.381058 0.686441 -0.999969 0.000092 -0.006714 255 255 255
-0.606400 -0.381057 1.201853 -0.999969 0.000092 -0.006714 255 255 255
-0.602927 -0.381058 0.686441 -0.000092 -1.000000 0.000000 255 255 255
-0.308500 -0.381092 0.687254 -0.000092 -1.000000 0.000000 255 255 255
-0.276009 -0.381096 1.201853 -0.000092 -1.000000 0.000000 255 255 255
-0.606400 -0.381057 1.201853 -0.000092 -1.000000 0.000000 255 255 255
-0.513477 -0.381068 0.575675 -0.183294 -0.553209 -0.812586 255 255 255
-0.602927 -0.381058 0.686441 -0.515641 -0.413862 -0.750206 255 255 255
-0.385255 -0.273727 0.542839 -0.114536 -0.379467 -0.918058 255 255 255
0.155277 -0.368391 0.685249 -0.241920 -0.952025 -0.187323 255 255 255
-0.030797 -0.276662 0.685750 -0.184423 -0.845637 -0.500839 255 255 255
-0.038865 -0.205954 0.468709 -0.027558 -0.981689 -0.188360 255 255 255
-0.252358 -0.241483 0.557752 0.180090 -0.950499 -0.253090 255 255 255
-0.276009 -0.381096 1.201853 0.018647 -0.931700 0.362743 255 255 255
-0.292260 -0.343467 1.282240 0.018647 -0.931700 0.362743 255 255 255
-0.590140 -0.343432 1.314751 0.018647 -0.931700 0.362743 255 255 255
-0.606400 -0.381057 1.201853 0.018647 -0.931700 0.362743 255 255 255
-0.276009 -0.381096 1.201853 0.997986 -0.000092 -0.062990 255 255 255
-0.308500 -0.381092 0.687254 0.997986 -0.000092 -0.062990 255 255 255
0.088154 -0.084160 0.345634 0.008637 0.006317 0.999939 65 69 189
0.144344 -0.111860 0.345132 0.012177 -0.000855 0.999908 65 69 189
0.244524 -0.098052 0.343127 0.019593 -0.014435 0.999695 65 69 189
0.294971 -0.062027 0.343127 0.000000 0.000000 1.000000 65 69 189
0.448630 -0.257099 0.614352 -0.313211 0.696921 0.645100 255 255 255
0.244524 -0.098052 0.343127 -0.240486 0.746788 0.620045 255 255 255
0.144344 -0.111860 0.345132 0.175207 0.829676 0.529984 255 255 255
0.183640 -0.293621 0.616357 0.111179 0.833338 0.541429 255 255 255
0.582068 -0.161808 0.614352 -0.557573 0.388684 0.733482 255 255 255
0.294971 -0.062027 0.343127 -0.528062 0.445326 0.723045 255 255 255
0.035011 -0.220352 0.616859 0.653218 0.617573 0.438032 255 255 255
0.088154 -0.084160 0.345634 0.727439 0.545335 0.416395 255 255 255
0.448630 -0.257099 0.683244 -0.368999 0.929411 0.000000 255 255 255
0.448630 -0.257099 0.614352 -0.370098 0.928953 0.000000 255 255 255
0.183640 -0.293621 0.616357 0.158818 0.987304 0.000000 255 255 255
0.183640 -0.293621 0.685249 0.160833 0.986969 0.000000 255 255 255
0.582068 -0.161808 0.683244 -0.798456 0.602008 0.000000 255 255 255
0.582068 -0.161808 0.614352 -0.798456 0.602008 0.000000 255 255 255
0.035011 -0.220352 0.685750 0.758385 0.651753 0.000000 255 255 255
0.035011 -0.220352 0.616859 0.758232 0.651936 0.000000 255 255 255
-0.030797 -0.276662 0.685750 0.002441 0.000122 0.999969 255 255 255
-0.225133 -0.275702 0.686252 0.002564 -0.002838 0.999969 255 255 255
0.487029 -0.322667 0.683244 0.002930 0.000183 0.999969 255 255 255
0.448630 -0.257099 0.683244 0.003601 0.000244 0.999969 255 255 255
0.183640 -0.293621 0.685249 0.004669 -0.000427 0.999969 255 255 255
0.155277 -0.368391 0.685249 0.004059 -0.000702 0.999969 255 255 255
0.654086 -0.203368 0.683244 0.000000 0.000000 1.000000 255 255 255
0.582068 -0.161808 0.683244 0.000000 0.000000 1.000000 255 255 255
0.035011 -0.220352 0.685750 0.000763 0.000092 0.999969 255 255 255

[indices]
0 1 2
3 4 1 3 1 0
4 5 1
6 7 8
9 7 10
11 12 13 11 13 14
15 16 17 15 17 18
19 20 21
6 22 23
7 1 5
24 8 21
25 26 24 25 24 27
28 29 30
29 31 32
33 34 35 33 35 36
37 38 39 37 39 40
41 42 4 41 4 3
43 44 45 43 45 46
47 48 8 47 8 5
20 27 21
49 50 51 49 51 52
53 54 50 53 50 49
24 21 27
42 47 5 42 5 4
48 19 21 48 21 8
23 55 54 23 54 53
55 23 22 55 22 56
26 57 56 26 56 22
24 26 6
6 26 22
8 24 6
5 8 7
49 29 28
52 31 29
49 52 29
9 2 1
58 30 59
10 7 60
23 61 30
30 61 28
49 28 61
53 49 61
53 61 23
29 59 30
9 10 2
30 2 10
30 10 23
60 23 10
23 60 6
60 7 6
30 58 2
58 0 2
57 26 25
57 25 62
63 64 65 63 65 66
67 68 69 67 69 70
9 1 7
71 72 73
74 71 73
75 74 73
73 76 75
77 78 79 77 79 80
81 77 80 81 80 82
83 81 82 83 82 84
85 86 87 85 87 88
78 85 88 78 88 79
89 90 91 89 91 92
93 89 92 93 92 94
95 93 94 95 94 96
97 98 99 97 99 100
90 97 100 90 100 91
101 102 103
101 103 104
105 106 107 105 107 108
109 105 108 109 108 110
111 109 110 111 110 112
101 104 113 101 113 114
106 101 114 106 114 107
115 116 117
118 115 117 118 117 119
119 117 120
121 122 123
124 125 123
126 14 13 126 13 127
15 18 128 15 128 129
19 130 20
121 131 132
123 120 117
133 130 122
134 135 133 134 133 136
137 138 139
139 32 140
141 142 143 141 143 144
145 36 35 145 35 146
37 40 147 37 147 148
41 118 119 41 119 42
149 150 151 149 151 152
47 120 122 47 122 48
20 130 135
153 154 51 153 51 50
155 153 50 155 50 54
133 135 130
42 119 120 42 120 47
48 122 130 48 130 19
131 155 54 131 54 55
55 56 132 55 132 131
136 132 56 136 56 57
133 121 136
121 132 136
122 121 133
120 123 122
153 140 154
137 139 140
153 137 140
124 117 116
156 157 138
125 158 123
131 138 159
138 137 159
153 159 137
155 159 153
155 131 159
139 138 157
124 116 125
138 125 116
138 131 125
158 125 131
131 121 158
158 121 123
138 116 156
156 116 115
57 134 136
57 62 134
160 161 162 160 162 163
67 164 165 67 165 68
124 123 117
166 73 72
167 73 166
168 73 167
73 168 169
170 171 172 170 172 173
174 175 171 174 171 170
83 84 175 83 175 174
176 177 87 176 87 86
173 172 177 173 177 176
178 179 180 178 180 181
182 183 179 182 179 178
95 96 183 95 183 182
184 185 99 184 99 98
181 180 185 181 185 184
186 103 187
186 104 103
188 189 190 188 190 191
192 193 189 192 189 188
111 112 193 111 193 192
186 194 113 186 113 104
191 190 194 191 194 186

[test]
clear

depthTestEnable true
depthWriteEnable true
depthCompareOp VK_COMPARE_OP_LESS
cullMode VK_CULL_MODE_BACK_BIT

uniform ubo 0 mat4 0 2.74747753 0 0 0 0 -2.37938523 0.724122345 0.5 0 -1.37373877 -1.25421667 -0.866025388 -10.4680815 4.44546318 9.73129177 13.3518381
uniform ubo 0 mat3 64 1 0 0 0 0.866025388 -0.5 0 0.5 0.866025388
uniform frame_num 0

draw arrays instanced indexed TRIANGLE_LIST 0 672 25
